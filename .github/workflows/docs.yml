name: 'Create iOS Changelog Docs PR'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the changelog docs PR'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version number for the changelog docs PR'
        required: true
        type: string

jobs:
  create-ios-changelog-docs:
    name: 'Create iOS Changelog Docs PR'
    runs-on: 'ubuntu-latest'
    permissions:
      contents: write
    steps:
      - name: 'Checkout main'
        uses: 'actions/checkout@v5'
        with:
          path: 'src'
          ref: 'main'

      - name: 'Checkout docs repository'
        uses: 'actions/checkout@v5'
        with:
          path: 'docs'
          ref: 'main'
          repository: 'joyfill/docs'
          token: ${{ secrets.API_REF_REPO_TOKEN }}

      - name: 'Generate releases.mdx from CHANGELOG.md'
        run: ./src/scripts/create_release_mdx.sh src/CHANGELOG.md docs/ios/changelogs/releases.mdx

      - name: 'Check for changes'
        id: newFiles
        working-directory: docs
        run: |
          if [[ $(git status --porcelain | wc -l) -gt 0 ]]; then
            echo "hasNewFiles=true" >> $GITHUB_OUTPUT
          else
            echo "hasNewFiles=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Setup Git'
        if: ${{ steps.newFiles.outputs.hasNewFiles == 'true' }}
        working-directory: docs
        run: git config --global http.postBuffer 524288000

      - name: 'Create Pull Request'
        if: ${{ steps.newFiles.outputs.hasNewFiles == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.API_REF_REPO_TOKEN }}
          path: 'docs'
          title: 'iOS SDK changelog docs update for (${{ inputs.version }})'
          body: |
            ## iOS Changelog Docs Update for Version ${{ inputs.version }}

            This PR updates the iOS SDK changelog documentation on the docs site.

            ### What's Included
            - Re-generated `ios/changelogs/releases.mdx` using the script and the latest `CHANGELOG.md` content.

            ### Context
            This PR is automatically created as part of the release preparation process for [components-swift](https://github.com/${{ github.repository }}).

            ### Next Steps
            - Review the generated changelog page on the docs site structure (`ios/changelogs/releases.mdx`)
            - Merge this PR to publish the updated changelog for version **${{ inputs.version }}**

            ---

            *This PR was automatically generated by the release preparation workflow.*
          commit-message: 'docs: update ios changelog for ${{ inputs.version }}'
          branch: 'docs/ios-changelog-${{ inputs.version }}'
          reviewers: ${{ github.actor }}
          assignees: ${{ github.actor }}
          labels: |
            ios
            documentation
          base: 'main'

