name: 'Create iOS API References PR'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the API references'
        required: true
        type: string
  workflow_call:
    inputs:
      version:
        description: 'Version number for the API references'
        required: true
        type: string

jobs:
  create-ios-api-references:
    name: 'Create iOS API References PR'
    runs-on: 'macos-14'
    permissions:
      contents: write
    steps:
      - name: 'Checkout main'
        uses: 'actions/checkout@v5'
        with:
          path: 'src'
          ref: 'main'

      - name: 'Setup Xcode'
        uses: 'maxim-lobanov/setup-xcode@v1'
        with:
          xcode-version: 'latest-stable'

      - name: 'Checkout api-references repository'
        uses: 'actions/checkout@v5'
        with:
          path: 'api-references'
          ref: 'main'
          repository: 'joyfill/api-references'
          token: ${{ secrets.API_REF_REPO_TOKEN }}

      - name: 'Generate DocC documentation for Joyfill'
        working-directory: src
        run: |
          # Generate DocC archive for Joyfill (main UI library)
          xcodebuild docbuild \
            -scheme Joyfill \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData
          
          # Find the generated .doccarchive
          DOCC_ARCHIVE=$(find ./DerivedData -name "Joyfill.doccarchive" | head -n 1)
          
          # Convert to static HTML
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --output-path ./docs-output/Joyfill \
            --hosting-base-path /reference/ios/Joyfill

      - name: 'Generate DocC documentation for JoyfillModel'
        working-directory: src
        run: |
          xcodebuild docbuild \
            -scheme JoyfillModel \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData
          
          DOCC_ARCHIVE=$(find ./DerivedData -name "JoyfillModel.doccarchive" | head -n 1)
          
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --output-path ./docs-output/JoyfillModel \
            --hosting-base-path /reference/ios/JoyfillModel

      - name: 'Generate DocC documentation for JoyfillFormulas'
        working-directory: src
        run: |
          xcodebuild docbuild \
            -scheme JoyfillFormulas \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData
          
          DOCC_ARCHIVE=$(find ./DerivedData -name "JoyfillFormulas.doccarchive" | head -n 1)
          
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --output-path ./docs-output/JoyfillFormulas \
            --hosting-base-path /reference/ios/JoyfillFormulas

      - name: 'Generate DocC documentation for JoyfillAPIService'
        working-directory: src
        run: |
          xcodebuild docbuild \
            -scheme JoyfillAPIService \
            -destination 'generic/platform=iOS' \
            -derivedDataPath ./DerivedData
          
          DOCC_ARCHIVE=$(find ./DerivedData -name "JoyfillAPIService.doccarchive" | head -n 1)
          
          xcrun docc process-archive transform-for-static-hosting \
            "$DOCC_ARCHIVE" \
            --output-path ./docs-output/JoyfillAPIService \
            --hosting-base-path /reference/ios/JoyfillAPIService

      - name: 'Copy generated docs to api-references repository'
        run: |
          # Create ios directory if it doesn't exist
          mkdir -p api-references/reference/ios
          
          # Remove old docs and copy new ones
          rm -rf api-references/reference/ios/*
          cp -r src/docs-output/* api-references/reference/ios/

      - name: 'Check for changes'
        id: newFiles
        working-directory: api-references
        run: |
          if [[ $(git status --porcelain | wc -l) -gt 0 ]]; then
            echo "hasNewFiles=true" >> $GITHUB_OUTPUT
          else
            echo "hasNewFiles=false" >> $GITHUB_OUTPUT
          fi

      - name: 'Setup Git'
        if: ${{ steps.newFiles.outputs.hasNewFiles == 'true' }}
        working-directory: api-references
        run: git config --global http.postBuffer 524288000

      - name: 'Create Pull Request'
        if: ${{ steps.newFiles.outputs.hasNewFiles == 'true' }}
        uses: peter-evans/create-pull-request@v7
        with:
          token: ${{ secrets.API_REF_REPO_TOKEN }}
          path: 'api-references'
          title: 'iOS SDK API references update for (${{ inputs.version }})'
          body: |
            ## iOS SDK API References Update for Version ${{ inputs.version }}

            This PR updates the iOS SDK API reference documentation.

            ### What's Included
            - Generated DocC documentation for all Joyfill iOS modules:
              - Joyfill (main UI library)
              - JoyfillModel
              - JoyfillFormulas
              - JoyfillAPIService
            - Static HTML documentation ready for hosting

            ### Context
            This PR is automatically created as part of the release preparation process for [components-swift](https://github.com/${{ github.repository }}).

            ### Next Steps
            - Review the generated API reference documentation
            - Merge this PR to publish the updated API references for version **${{ inputs.version }}**

            ---

            *This PR was automatically generated by the release preparation workflow.*
          commit-message: 'docs: update ios api references for ${{ inputs.version }}'
          branch: 'docs/ios-api-references-${{ inputs.version }}'
          reviewers: ${{ github.actor }}
          assignees: ${{ github.actor }}
          labels: |
            ios
            documentation
            api-references
          base: 'main'

