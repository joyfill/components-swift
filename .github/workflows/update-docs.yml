name: Update Docs on Release

on:
  release:
    types: [published]
  # ðŸ‘‡ Manual Trigger with Custom Inputs for Testing
  workflow_dispatch:
    inputs:
      test_tag:
        description: 'Test Version (e.g. 3.0.0-beta)'
        default: '3.0.0-test'
        required: true
      test_body:
        description: 'Release Notes (Paste your content here)'
        required: true
        default: "### Added\n- Custom test feature 1\n- Custom test feature 2"

jobs:
  create-docs-pr:
    name: 'Create Docs PR'
    runs-on: 'ubuntu-latest'
    steps:
      # 1. Checkout iOS SDK (Source) - Needed to get the script
      - name: Checkout SDK
        uses: actions/checkout@v4
        with:
          path: ios-sdk
          ref: ${{ github.event_name == 'workflow_dispatch' && 'main' || github.ref }}

      # 2. Checkout Docs Repo (Destination)
      - name: Checkout Docs Repo
        uses: actions/checkout@v4
        with:
          repository: 'joyfill/docs'
          token: ${{ secrets.UPDATE_DOCS_TOKEN }}
          path: 'docs'

      # 3. Get Release Notes (From Release UI or Manual Input)
      - name: Get Release Notes
        run: |
          # A. Determine Version and Content
          if [ "${{ github.event_name }}" == "workflow_dispatch" ]; then
            TARGET_VER="${{ inputs.test_tag }}"
            RELEASE_BODY="${{ inputs.test_body }}"
          else
            TARGET_VER="${{ github.event.release.tag_name }}"
            RELEASE_BODY="${{ github.event.release.body }}"
          fi
          
          echo "Processing version: $TARGET_VER"
          echo "VERSION=$TARGET_VER" >> $GITHUB_ENV
          
          # B. Create the input file manually
          # We add the header "## Version" so the script knows what to do
          echo "## $TARGET_VER" > release_notes_input.md
          echo "" >> release_notes_input.md
          echo -e "$RELEASE_BODY" >> release_notes_input.md
          
          echo "--- Content to be inserted ---"
          cat release_notes_input.md

      # 4. Run the Insert Script
      - name: Insert into Docs
        run: |
          # Ensure the folder exists
          mkdir -p docs/ios/changelogs
          chmod +x ios-sdk/scripts/update_release_mdx.sh
          
          # Run script with the file we created in Step 3
          ./ios-sdk/scripts/update_release_mdx.sh release_notes_input.md 'docs/ios/changelogs/RELEASE_NOTES.mdx'

      # 5. Create Pull Request
      - name: Create Pull Request
        uses: peter-evans/create-pull-request@v5
        with:
          token: ${{ secrets.UPDATE_DOCS_TOKEN }}
          path: 'docs'
          commit-message: 'docs: add release notes for ${{ env.VERSION }}'
          title: 'docs: add release notes for ${{ env.VERSION }}'
          body: |
            Automated PR adding release notes for **${{ env.VERSION }}**.
            
            Generated from GitHub Release description.
          branch: 'docs-update-${{ env.VERSION }}'
          base: 'main'
          delete-branch: true
