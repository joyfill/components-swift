name: iOS Advanced CI Pipeline

# Only trigger on PR/MR events + manual trigger
on:
  # When PR/MR is raised or updated - WORKS FOR ALL BRANCHES! ‚úÖ
  pull_request:
    types: [opened, synchronize, reopened, ready_for_review]
    # NO branch restrictions = runs on PRs to ANY branch

  # Manual trigger with full control
  workflow_dispatch:
    inputs:
      pipeline_type:
        description: 'Select Pipeline Type'
        required: true
        default: 'pre-merge'
        type: choice
        options:
        - 'quick-check'      # Fast: Syntax only (30 seconds)
        - 'pre-merge'        # Standard: Syntax + Build + Unit tests (3-5 min)
        - 'full-validation'  # Complete: Syntax + Build + Unit + UI tests (8-12 minutes)
        - 'with-lint'        # Pre-merge + SwiftLint (5-7 minutes)
        - 'custom'           # Choose individual options

      # Custom options
      run_lint:
        description: 'SwiftLint code quality'
        required: false
        default: true
        type: boolean
      run_syntax_check:
        description: 'Swift syntax validation'
        required: false
        default: true
        type: boolean
      run_build:
        description: 'Full simulator build'
        required: false
        default: false
        type: boolean
      run_unit_tests:
        description: 'Unit tests with coverage'
        required: false
        default: false
        type: boolean
      run_ui_tests:
        description: 'UI automation tests'
        required: false
        default: false
        type: boolean

# Default pipeline level for PR triggers
env:
  # Use pre-merge as default for all PR events
  PIPELINE_TYPE: ${{ github.event.inputs.pipeline_type || 'pre-merge' }}

jobs:
  # üîç Job 1: SwiftLint (Code Quality)
  lint:
    name: "üîç SwiftLint"
    runs-on: macos-14  # Latest macOS runner
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.pipeline_type == 'with-lint' || (github.event.inputs.pipeline_type == 'custom' && github.event.inputs.run_lint == 'true')) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4  # ‚úÖ Latest is v4 (not v5)

      - name: Cache SwiftLint
        uses: actions/cache@v4
        with:
          path: /opt/homebrew/bin/swiftlint
          key: ${{ runner.os }}-swiftlint-${{ runner.arch }}
          restore-keys: |
            ${{ runner.os }}-swiftlint-
      - name: Run SwiftLint
        run: |
          cd JoyfillSwiftUIExample
          
          # Install SwiftLint if not cached
          if ! which swiftlint >/dev/null; then
            echo "Installing SwiftLint..."
            brew install swiftlint
          fi
          
          # Run SwiftLint with proper error handling
          echo "Running SwiftLint..."
          swiftlint lint --reporter github-actions-logging --strict || LINT_EXIT_CODE=$?
          swiftlint lint --reporter html > swiftlint-report.html
          
          # Exit with proper code
          exit ${LINT_EXIT_CODE:-0}
      - name: Upload SwiftLint Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: swiftlint-report
          path: JoyfillSwiftUIExample/swiftlint-report.html
          retention-days: 30  # Auto-cleanup after 30 days

  # ‚ö° Job 2: Swift Syntax Check (Super Fast)
  syntax-check:
    name: "‚ö° Syntax Check"
    runs-on: macos-14
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.pipeline_type != 'custom' || github.event.inputs.run_syntax_check == 'true')) }}
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode 16+
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '>=16.0'

      - name: Swift Syntax Validation
        run: |
          cd JoyfillSwiftUIExample
          echo "üîç Validating Swift syntax..."
          
          SYNTAX_ERRORS=0
          while IFS= read -r -d '' file; do
            echo "Checking: $file"
            if ! xcrun swift -frontend -parse "$file" -sdk $(xcrun --show-sdk-path --sdk iphonesimulator) 2>/dev/null; then
              echo "‚ùå Syntax error in: $file"
              ((SYNTAX_ERRORS++))
            fi
          done < <(find . -name "*.swift" -not -path "./Pods/*" -not -path "./build/*" -not -path "./DerivedData/*" -print0)
          
          if [ $SYNTAX_ERRORS -gt 0 ]; then
            echo "‚ùå Found $SYNTAX_ERRORS files with syntax errors"
            exit 1
          else
            echo "‚úÖ All Swift files have valid syntax!"
          fi

  # üèóÔ∏è Job 3: Full Build
  build:
    name: "üèóÔ∏è Build"
    runs-on: macos-14
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.pipeline_type == 'pre-merge' || github.event.inputs.pipeline_type == 'full-validation' || github.event.inputs.pipeline_type == 'with-lint' || (github.event.inputs.pipeline_type == 'custom' && github.event.inputs.run_build == 'true'))) }}
    needs: [syntax-check]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode 16+
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '>=16.0'

      - name: Xcode & Simulators (diagnostics)
        run: |
          xcodebuild -version
          xcode-select -p
          xcrun simctl list runtimes
          xcrun simctl list devices

      - name: Install xcpretty
        run: |
          if ! gem list xcpretty -i; then
            gem install xcpretty
          fi

      - name: Build for Simulator
        run: |
          set -o pipefail
          cd JoyfillSwiftUIExample
          
          xcodebuild clean build \
            -project JoyfillExample.xcodeproj \
            -scheme JoyfillExample \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            EXCLUDED_ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
          | xcpretty --color --report html --output build-report.html
          
          echo "‚úÖ Build completed successfully!"
      - name: Upload Build Report
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: build-report-${{ github.run_number }}  # Unique name
          path: JoyfillSwiftUIExample/build-report.html
          retention-days: 30

  # üß™ Job 4: Unit Tests
  unit-tests:
    name: "üß™ Unit Tests"
    runs-on: macos-14
    if: ${{ github.event_name == 'pull_request' || (github.event_name == 'workflow_dispatch' && (github.event.inputs.pipeline_type == 'pre-merge' || github.event.inputs.pipeline_type == 'full-validation' || github.event.inputs.pipeline_type == 'with-lint' || (github.event.inputs.pipeline_type == 'custom' && github.event.inputs.run_unit_tests == 'true'))) }}
    needs: [build]
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode 16+
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '>=16.0'

      - name: Install xcpretty
        run: |
          if ! gem list xcpretty -i; then
            gem install xcpretty
          fi

      - name: Run Unit Tests
        run: |
          set -o pipefail
          cd JoyfillSwiftUIExample
          xcodebuild test \
            -project JoyfillExample.xcodeproj \
            -scheme JoyfillTests \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            EXCLUDED_ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
          | xcpretty --color --report html --output unit-test-report.html
      - name: Upload Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: unit-test-results-${{ github.run_number }}
          path: |
            JoyfillSwiftUIExample/unit-test-report.html
            JoyfillSwiftUIExample/TestResults.xcresult
          retention-days: 30

  # üñ±Ô∏è Job 5: UI Tests
  ui-tests:
    name: "üñ±Ô∏è UI Tests"
    runs-on: macos-14
    if: ${{ github.event_name == 'workflow_dispatch' && (github.event.inputs.pipeline_type == 'full-validation' || (github.event.inputs.pipeline_type == 'custom' && github.event.inputs.run_ui_tests == 'true')) }}
    needs: [build]
    timeout-minutes: 30  # ‚Üê HERE IS THE 30-MINUTE TIMEOUT! üéØ
    steps:
      - name: Checkout code
        uses: actions/checkout@v4

      - name: Setup Xcode 16+
        uses: maxim-lobanov/setup-xcode@v1
        with:
          xcode-version: '>=16.0'

      - name: Install xcpretty
        run: |
          if ! gem list xcpretty -i; then
            gem install xcpretty
          fi

      - name: Boot iOS Simulator
        run: |
          xcrun simctl boot "iPhone 16 Pro" || true
          sleep 10
          xcrun simctl list devices | grep "iPhone 16 Pro"

      - name: Run UI Tests
        run: |
          set -o pipefail
          cd JoyfillSwiftUIExample
          xcodebuild test \
            -project JoyfillExample.xcodeproj \
            -scheme JoyfillUITests \
            -sdk iphonesimulator \
            -destination 'platform=iOS Simulator,name=iPhone 16 Pro,OS=latest' \
            CODE_SIGN_IDENTITY="" \
            CODE_SIGNING_REQUIRED=NO \
            CODE_SIGNING_ALLOWED=NO \
            EXCLUDED_ARCHS=arm64 \
            ONLY_ACTIVE_ARCH=YES \
          | xcpretty --color --report html --output ui-test-report.html
      - name: Upload UI Test Results
        uses: actions/upload-artifact@v4
        if: always()
        with:
          name: ui-test-results-${{ github.run_number }}
          path: |
            JoyfillSwiftUIExample/ui-test-report.html
            JoyfillSwiftUIExample/UITestResults.xcresult
          retention-days: 30

  # üìä Job 6: Results Summary
  results-summary:
    name: "üìä Results Summary"
    runs-on: macos-14
    needs: [lint, syntax-check, build, unit-tests, ui-tests]
    if: always()
    steps:
      - name: Generate Summary
        run: |
          echo "# üìä CI Pipeline Results" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "| Job | Status |" >> $GITHUB_STEP_SUMMARY
          echo "|-----|--------|" >> $GITHUB_STEP_SUMMARY
          echo "| üîç SwiftLint | ${{ needs.lint.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| ‚ö° Syntax Check | ${{ needs.syntax-check.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üèóÔ∏è Build | ${{ needs.build.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üß™ Unit Tests | ${{ needs.unit-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "| üñ±Ô∏è UI Tests | ${{ needs.ui-tests.result }} |" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          
          # Overall status - consider success if core jobs (syntax, build, unit-tests) pass
          # Lint and UI tests are optional and can be skipped
          LINT_OK="${{ needs.lint.result == 'success' || needs.lint.result == 'skipped' }}"
          SYNTAX_OK="${{ needs.syntax-check.result == 'success' }}"
          BUILD_OK="${{ needs.build.result == 'success' || needs.build.result == 'skipped' }}"
          UNIT_OK="${{ needs.unit-tests.result == 'success' || needs.unit-tests.result == 'skipped' }}"
          UI_OK="${{ needs.ui-tests.result == 'success' || needs.ui-tests.result == 'skipped' }}"
          
          if [[ "$SYNTAX_OK" == "true" && "$BUILD_OK" == "true" && "$UNIT_OK" == "true" && "$LINT_OK" == "true" && "$UI_OK" == "true" ]]; then
            echo "## ‚úÖ Build Status: PASSING" >> $GITHUB_STEP_SUMMARY
            echo "All jobs completed successfully or were skipped as expected." >> $GITHUB_STEP_SUMMARY
          else
            echo "## ‚ùå Build Status: FAILING" >> $GITHUB_STEP_SUMMARY
            echo "One or more jobs failed. Check individual job results above." >> $GITHUB_STEP_SUMMARY
          fi
          
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "---" >> $GITHUB_STEP_SUMMARY
          echo "## üéØ Need to Run Skipped Jobs?" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "If any jobs were skipped and you want to run them individually:" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "1. Go to **Actions** tab" >> $GITHUB_STEP_SUMMARY
          echo "2. Select **üéØ Run Individual Jobs** workflow" >> $GITHUB_STEP_SUMMARY
          echo "3. Click **Run workflow** and choose:" >> $GITHUB_STEP_SUMMARY
          echo "   - \`swiftlint-only\` - Run only SwiftLint" >> $GITHUB_STEP_SUMMARY
          echo "   - \`ui-tests-only\` - Run only UI Tests" >> $GITHUB_STEP_SUMMARY
          echo "   - \`custom-selection\` - Pick individual jobs" >> $GITHUB_STEP_SUMMARY
          echo "" >> $GITHUB_STEP_SUMMARY
          echo "üí° **Quick Links for Skipped Jobs:**" >> $GITHUB_STEP_SUMMARY
          
          # Show specific suggestions based on what was skipped
          if [[ "${{ needs.lint.result }}" == "skipped" ]]; then
            echo "- **SwiftLint was skipped** ‚Üí Use \`swiftlint-only\` option" >> $GITHUB_STEP_SUMMARY
          fi
          
          if [[ "${{ needs.ui-tests.result }}" == "skipped" ]]; then
            echo "- **UI Tests were skipped** ‚Üí Use \`ui-tests-only\` option" >> $GITHUB_STEP_SUMMARY
          fi
