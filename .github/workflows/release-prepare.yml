name: 'Prepare iOS Release'

on:
  workflow_dispatch:
    inputs:
      version:
        description: 'Version number for the release (e.g., 1.0.0, 1.0.0-RC1, 1.0.0-beta.1)'
        required: true
        type: string

jobs:
  prepare-release:
    name: 'Prepare Release PR'
    runs-on: 'macos-14'
    permissions:
      contents: write
      pull-requests: write
    steps:
      - name: 'Checkout main'
        uses: 'actions/checkout@v5'
        with:
          ref: 'main'

      - name: 'Update Package.swift version'
        run: |
          # Note: Swift Package Manager doesn't have a version field in Package.swift
          # Version is managed through Git tags. This step is for documentation purposes.
          echo "Version ${{ inputs.version }} will be tagged after release PR is merged"

      - name: 'Update Joyfill.podspec version'
        run: |
          sed -i '' "s/spec.version[[:space:]]*=[[:space:]]*['\"][^'\"]*['\"]/spec.version = '${{ inputs.version }}'/" Joyfill.podspec

      - name: 'Update CHANGELOG.md'
        run: ./scripts/add_version_to_changelog.sh ${{ inputs.version }} CHANGELOG.md ${RUNNER_TEMP}/changelog_temp.txt

      - name: 'Create Pull Request'
        uses: 'peter-evans/create-pull-request@v7'
        with:
          token: ${{ secrets.GITHUB_TOKEN }}
          title: 'Release ${{ inputs.version }}'
          body: |
            ## iOS SDK Release ${{ inputs.version }}

            This PR prepares the release for version **${{ inputs.version }}**.

            ### Changes Included
            - Updated `Joyfill.podspec` to version ${{ inputs.version }}
            - Updated `CHANGELOG.md` with new version section

            ### Release Checklist
            - [ ] Review CHANGELOG.md entries
            - [ ] Verify version number is correct
            - [ ] Ensure all tests pass
            - [ ] Check API reference generation works
            - [ ] Verify podspec is valid (`pod spec lint`)

            ### Next Steps
            1. Fill in the CHANGELOG.md with actual changes for this release
            2. Review and approve this PR
            3. Merge to main (will automatically trigger release workflow)

            ---

            *This PR was automatically generated by the release preparation workflow.*
          commit-message: 'chore: prepare release ${{ inputs.version }}'
          branch: 'release/${{ inputs.version }}'
          reviewers: ${{ github.actor }}
          assignees: ${{ github.actor }}
          labels: |
            release
            ios
          base: 'main'

  create-api-references:
    name: 'Create API References PR'
    needs: prepare-release
    uses: ./.github/workflows/api-references.yml
    secrets: inherit
    with:
      version: ${{ inputs.version }}

